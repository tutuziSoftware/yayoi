<!DOCTYPE HTML>
<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <title>Jasmine Spec Runner v2.0.0</title>

  <link rel="shortcut icon" type="image/png" href="lib/jasmine-2.0.0/jasmine_favicon.png">
  <link rel="stylesheet" type="text/css" href="lib/jasmine-2.0.0/jasmine.css">

  <script type="text/javascript" src="lib/jasmine-2.0.0/jasmine.js"></script>
  <script type="text/javascript" src="lib/jasmine-2.0.0/jasmine-html.js"></script>
  <script type="text/javascript" src="lib/jasmine-2.0.0/boot.js"></script>
  <script type="text/javascript" src="http://localhost:3000/javascripts/jquery-2.1.1.min.js"></script>
  <script src="/socket.io/socket.io.js"></script>

  <!-- include spec files here... -->
	<script>
		describe("クローンフィールドの動作", function(){
			var socket;
			
			beforeEach(function(done){
				if(socket){
					console.log("beforeEach - socket");
					setTimeout(function(){
						done();
					}, 0);
					return;
				}
				
				document.cookie = "";
				
				//ログイン + socket.ioで通信可能にする
				$.post("/login", {
					"userName":"puruhime",
					"password":"puruhime"
				}, function(data){
					socket = io.connect('http://localhost:3000/battle/tester');
				
					socket.on("connect", function(){
						console.log("beforeEach - connect");
						done();
					});
				});
				
				console.log("beforeEach");
			});
			
			describe("フィールド形成", function(){
				var field;
				
				it("shuffle APIの使用", function(done){
					socket.on("first draw", function(_field){
						console.log("first draw");
						expect(_field).toBeDefined();
						field = _field;
						socket.removeListener("first draw", arguments.callee);
						console.log("first draw - done");
						done();
						console.log("first draw - done2");
					});
		
					console.log("shuffle");
					socket.emit("shuffle");
				});
				
				it("shuffle API直後のクローンフィールド", function(done){
					socket.on("clone field!", function(_field){
						console.log(_field);
						expect(_field).toBeDefined();
						expect(_field.i).toBeDefined();
						expect(_field.i.hands.length).toEqual(5);
						expect(_field.i.life).toEqual(20);
						socket.removeListener("clone field!", arguments.callee);
						console.log("clone field!");
						done();
					});
					
					console.log("clone field?");
					socket.emit("clone field?");
				});
				
				it("灰色熊を場に出す", function(done){
					var run = false;
					
					socket.on("clone field!", function(_field){
						if(run) return;
						run = true;
						expect(_field).toBeDefined();
						expect(_field.i).toBeDefined();
						expect(_field.i.hands.length).toEqual(3);
						expect(_field.i.creatures.length).toEqual(1);
						expect(_field.i.creatures[0].id).toEqual(field.i.hands[1].id);
						socket.removeListener("clone field!", arguments.callee);
						done();
					});
					
					socket.emit("hand to mana", field.i.hands[0].id);
					socket.emit("play", field.i.hands[1].id);
					socket.emit("clone field?");
				});
				
				it("灰色熊の戦闘", function(done){
					socket.on("clone field!", function(field){
						//戦闘前はタップなし
						expect(field.i.creatures[0].tap).toEqual(void 0);
						
						socket.on("attack step", function(){
							socket.on("clone field!", function(field){
								//戦闘に参加させるとタップ & 攻撃フラグを立てる
								expect(field.i.creatures[0].tap).toEqual(true);
								expect(field.i.creatures[0].isAttack).toEqual(true);
								socket.removeListener("clone field!", arguments.callee);
								done();
							});
							
							socket.emit("clone field?");
						});
						
						socket.emit("attack step", [field.i.creatures[0].id]);
						socket.removeListener("clone field!", arguments.callee);
					});
					
					socket.emit("clone field?");
				});
				
				it("相手のターン　～ダメージ被弾", function(done){
					socket.on("enemy turn", function(field){
						//灰色熊のダメージを受けた
						expect(field.enemy.life).toEqual(18);
						socket.removeListener("enemy turn", arguments.callee);
						done();
					});
				});
				
				it("相手のターン　～灰色熊召喚");
				it("自分のターン");
				
				/*
				現状：自分のターンに関するAPIを作った。
				目標：敵ターン中のAPIを作りたい。
				TODO 敵ターン中のAPIをサーバ側に仮設置する(battle.js参照)
				TODO 常に灰色熊を出し、灰色熊で殴ってくるダミー敵を作る。
				TODO 対戦者がお互い認識出来るようにするには？(DBに対戦中である事を明記する？　それともファイル？)
				TODO 相手のセッションを覗き見出来るような方法を探る。
				*/
			});
		});
	</script>
</head>

<body>
</body>
</html>
